tic

experiment = {...
'test3 - Copy'
'test3 - Copy (2)'
'test3_flex'
'----ramptest_1'
'----stairtest'
'---flextest1'
'----flextest2'
'----flextest3'
'----flextest4'
'----flextest5'
'test3-20th'
'test320thb'
'day2_1  -ramp'
'day2_2-rampx10or9'
'day2_walk1'
'day2_stair-wait'
'day3_socket tap test'
'dy3_syncbefore'
'day3_walk+rampx5'
'day3_stairx5'
'wed2_error'
'wed2_walkx11'
'wed2_walk2x10_E' %_E
'wed2_rampx10'
'wed2_RAMP2X10'
'wed2_ramp3x10'
'temp'
'wed2_sitstandx20_E' %_E
'wed2_sitstand2x20'
'fail'
'wed2_walk_trunc'
'fault'
'wed2_walkfinalx10'
'wed2_rampfinalx20',
'wed2_sitstandx10trunc  '
'dy3_syncbefore (version 1) edit#.xlsb'
'thu2_walkx10'
'thu2_walk_datafail'
'thu2_walk_swfail_E' % _E
'thu2_walk2x10_E' % _E
'thu2_walk3x10_E' % _E
'thu2_rampx10fail'
'thu2_ramp2x15'
'thu2_ramp3x15_fault'
'thu2_stsx12_crash'
'thu2_stsxx28'
'Seac1_walk'
'Seac_2_muscleflex'
'Seac+_3walk_holres'
'Seac4_walk_4sensors'
'fri2_walkx10+time'
'fri2_walkx10#2'
'fri2_ramp1x10'
'fri2_ramp2x10'
'fri2_rampx10------hadafault'
'fri2_ramp4_x10'
'fri2_stsx20'
'fri2_stsx20LOST'
'fri2_sts3x20'
'fri2_flexex'
'sat2_walkx20'
'sat2_walk2x20'
'sat2_ramptrial'
'sat2_rampx19crash-----'
'sat2_rampre1_l_x20'
'sat2_ramp2_r_x20'
'sat2_stsx20'
'sat2_sts2x20'
'sat2_kneeextfelx_x20'
'sat2_c2_kneeflexexx20'
'sat2_c2_stsx20'
'sat2_c2_sts2x20'
'sat2_c2_walkx20'
'sat2_c2_ramp_l_x20'
'sat2_c2_ramp_r_x20'
'sun2_c1_walkx20'
'sun2_c1_ramp_fail'
'sun2_c1_ramp_r_x20'
'sun2_c1_ramp_l_x20'
'sun2_c1_stsx23'
'sun2_c1_sts2x23'
'sun2_c1_flexexx20'
'sun2_c2_stsx40'
'sun2_c2_flexexx23_E'
'sun2_c2_ramp_r_x10-Flostposs'
'sun2_c2_ramp_rl_x15x20'
'sun2_c2_walkx21_r'
'----_flex'
'----_walk'
'----_2legs_walk-rampx5'
'---_dorsi-plantar'
'----_ramp2x5-extratim'
'----_plantrx10'
'----_x10dorii-x10plamntar-nosocket'
'----_nosocketetstwithliner' % Leeds 2.2 10th Septmber onwards  :: currently one/two IMUs, 25 (nd 21) i believe
'----_nosocketetstwithliner_2' % #2 = #96
'----wlk5MMGsscket_1' % 97
'20180910142744-m4dg' % 10th Septemebr 2018, Amputee Subj day one, testing
'20180910143805-m4dg'
'20180910145034-m4dg' % 100
...
'20180911140907-m4dg' % 101 % 11th September Amputee Subj day one experimnt
'20180911145218-stop' % 102
'20180911145524-stop' % 103
'20180911150824-m4dg' % 104
'20180911152401-stop' % 105
'20180911152834-stop' % 106
'20180911162117-savve' % 107
'20180911162438-stop' % 108
'20180911162835-  save' % 109
'20180911163325-stop' % 110
'20180911163823-stop' % 111
'20180911164701-m4d' % 112
'20180911165021-stop' % 113
'20180911165353-stop' % 114
...
'20180912114220-  save3  ' % 115 % Amputee Subj day two experiment 
'20180912114710-065'
'20180912114947-stop'
'20180912115312-stop'
'20180912122932-stop'
'20180912124408-m4dg'
'20180912124605-stop'
'20180912130110-stop'
'20180912131601-stop'
'20180912131758-stop'
'20180912151511-m4dg'
'20180912152320-stop'
'20180912152522-stop'
'20180912153410-stop  '
'20180912153208-m4dg'
'20180912153608-stop'
'20180912154031-stop'
'20180912154835-stop'
'20180912160104-stop' % 133

'20180914125632-stop' % Control Subject 2 day one % #134
'20180914145957-save  '
'20180914151443-                              '
'20180914152657-m4dg'
'20180914154042-m4dg'
'20180914155424-stop'
'20180914162130-stop'
'20180914162828-stop'
'20180914163903-stop_WHATISTHIS'
'20180914165938-m4dg'
'20180914174844-stop'
'20180914180446-stop'
'20180914181039-stop'
'20180914185649-m4dg'
'20180914190311-stop'
'20180914190908-  '
'20180914191703-      '
'20180914192851-    save'
'20180914193239-stop'
'20180914193405-stopsave'
'20180914193716-stop'
'20180914200212-stop'

'20180915151812-stop' % Control Subject 2 day two % #156
'20180915152425-stop'
'20180915153044-stop'
'20180915154157-stop'
'20180915155459-stop'
'20180915160401-stop'
'20180915162850-stop'
'20180915163521-stop'
'20180915164502-stop'
'20180915165001-stop'
'20180915171239-stop'
'20180915172519-stop'
'20180915175756-stop'
'20180915180346-stop'
'20180915181125-'
'20180915182615-stop'
'20180915184754-  '
'20180915185601-    '
'20180915191626-stop'
'20180915192253-stop'
'20180915193243-stop'
'20180915193847-stop'
'20180915194738-stop'
'20180915200100-m4dg'
'20180915202348-stop'
'20180915202803-stop'
'20180915203002-stop'
'20180915203902-stop'
'20180915204044-m4dg' % 184

'20180918143525-m4dg' % #185 % Control Subject 1 day one
'20180918144202-'
'20180918144315-stop'
'20180918150238-stop'
'20180919164949-stop'
'20180919171628-m4dg'
'20180919172420-m4dg'
'20180919173439-m4dg'
'20180919175313-stop'
'20180919180457-m4dg'
'20180919182800-stop'
'20180919183635-stop'
'20180919184819-stop'
'20180919190509-stop'
'20180919191241-stop'
'20180919192237-stop'
'20180919192754-stop'
'20180919194732-stop'
'20180919195644-stop'
'20180920132554-stop'
'20180920133708-stop'
'20180920134803-stop'
'20180920135137-stop'
'20180920141156-stop'
'20180920141927-stop'
'20180920142643-stop'
'20180920143434-stop'
'20180920145641-stop'
'20180920150335-'
'20180920150745-stop'
'20180920152533-stop'
'20180920160441-stop'
'20180920161056-'
'20180920164045-stop'
'20180920164648-save3'
'20180920170454-stop'
'20180920171032-  '     % #221  

};



% for exp = [ 1 4 5 17 24 31 38 45 53  59 66 73 80 87 91 ...
% 2 6 16 25 32 39 46 52  60 67 74 81 88 92 ...
% 8 18 26 33 40 47 54  62 69 76 83 89 94 ...
% 7 23 27 37 41 48 55  63 70 77 84 90 95]

% for exp = [ ...
        
% % % array_sel = [ ... 
% % % %     1:48 ...
% % %         1 2 ...
% % %   4 5 6 8 7 ...
% % % ];
% 53 53 54 55 ...
% 59 60 62 63 ...
% 66 67 69 70 ...
% 73 74 76 77 ...
% 80 81 83 84 ...
% 87 88 89 90 ...
% 91 92 94 95 ...
% ];

%         1 2 ...
%   4 5 6 8 7 ...
% 17 16 18 23 ...
% 24 25 26 27 ...
% 31 32 33 37 ...
% 38 39 40 41 ...
% 45 46 47 48 ...


array221 = 1:221;
% array_sel = [17 45 47 48 49 50 64 65 79 81 82 88 89 91:96];
array_sel = [1:101];
array221(array_sel) = [];

array_rad = [ 13          22 30 36 44 51 58  65 72 79 86 97 ];
array_lgw = [ 10,11,12,15 21 29 35 43 50 57  64 71 78 85 96 ];

for exp = 124 %[142 145 152 165] %[145 152 165] %  [159 161] %:178 % 167 %214:218 % 115 % 155 %101%214:221 %:104 %:104 % algorithm composed for ex24 %array221 %4 %64 %array97 %64 % 29 % 97 %array_rad % array_lgw % array97
        
    
    
%     file  = char(experiment(exp));
% allRawData = dlmread([file '.csv']);



tic

filename = char(experiment{exp}); % NOTE FOLDER IS CORRECT!!
% filename1 = ([file '_ReSamp1_1k']);
% filename2 = ([file '_ReSamp1_1k']);

complete_exp1 = csvread([filename '_ReSamp1_1k.csv']) ;
complete_exp2 = csvread([filename '_ReSamp2_1k.csv']) ;

% complete_exp1 = complete_exp1_ /10;  % FORGOT TO CLIP THIS ROW IN PREVIOUS SCRIPT
% complete_exp2 = complete_exp2_; % wait no wrong

% % % % 4 % means temporarily set aside
% % % % complete_exp1(1,:) = [];  % FORGOT TO CLIP THIS ROW IN PREVIOUS SCRIPT
% % % % complete_exp2(1,:) = [];

i1 = size(complete_exp1,1);
i2 = size(complete_exp2,1);
if i1~=i2
     fprintf('experiments different lengths\nexperiments different lengths\n');
else ii=i1;
end

clearvars     IMUData1 IMUData2 ADCData1 ADCData2 QTNData1 QTNData2
clearvars     IMUData1_LPfilt IMUData2_LPfilt KneeVelocity_ KneeVelocity ...   % just try all (was leaving end of previous data sets)
                integral_KneeVelocity_ integral_KneeVelocity integral_KneeVelocity_func ...
                   differential_KneeVelocity differential_KneeVelocity_func KneeDisplacement_ ...
                      KneeDisplacement KneeDisplacement_func_ KneeDisplacement_func KneeAcceleration_func 

    IMUData1 = complete_exp1(:,1:9);
    IMUData2 = complete_exp2(:,1:9);
    ADCData1 = complete_exp1(:,10:17);  % note: ADC currently unfiltered in previous code
    ADCData2 = complete_exp2(:,10:17);
    QTNData1 = complete_exp1(:,18:21);
    QTNData2 = complete_exp2(:,18:21);
% could filter MMG here (in this script i mean)

    % filtering
    freq = 1000;
    samplePeriod = 1/freq;
    freq_MMG = 1000;
    samplePeriod_MMG = 1/freq_MMG;  %###
    freq_IMU = 1000;
    samplePeriod_IMU = 1/freq_IMU;  %###
    order = 4;
    filtcutlow = 1;
    filtcuthigh = 100; % 50;
    filter_multiplier = 0.08;   %???
    
%     highpassthresh = 0.04;      %??? manual trial and error at 200Hz ssampling freq
%     highpassthresh = 0.3;   %   "A practical gait analysis system using gyroscopes" Tong and Granat

% % % % ORIGINAL
% % %     highpassthresh = 0.04;
% % %     LP_freq = 4;           % call this filtcutlowinertial or something
    
    highpassthresh = 0.01;
    LP_freq = 499;           % call this filtcutlowinertial or something
     
% % % %     ORIGINAL
% % %     % bandpass for MMG
% % %     [b,a] = butter(order,[(2*filtcutlow)/freq_MMG (2*filtcuthigh)/freq_MMG],'bandpass');
% % %     
% % %     % high and low pass for IMU
    [d,c] = butter(order,(2*highpassthresh/freq_IMU),'high');
    [f,e] = butter(order,(2*LP_freq/freq_IMU),'low');
    [h,g] = butter(order,[(2*highpassthresh)/freq_IMU (2*LP_freq)/freq_IMU],'bandpass');    
    
    % bandpass for MMG
    [b,a] = butter(order,[(2*filtcutlow)/freq_MMG (2*filtcuthigh)/freq_MMG],'bandpass');
    
    % high and low pass for IMU
% % %     [d,c] = butter(order,(2*highpassthresh/freq_IMU),'high');
% % %     [f,e] = butter(order,(2*LP_freq/freq_IMU),'low');
% % %     [h,g] = butter(order,[(2*highpassthresh)/freq_IMU (2*LP_freq)/freq_IMU],'bandpass');
    
%     ORIGINAL
    %LOWPASS HERE  :: WAS ORIGINALLY LOW PASSED at 4Hz
%     IMUData1_LPfilt = filtfilt(h,g,IMUData1);   % 4Hz LOWPASS
%     IMUData2_LPfilt = filtfilt(h,g,IMUData2);   % filtfilt for offline, filter for real-time    
    
%     %LOWPASS HERE  :: WAS ORIGINALLY LOW PASSED at 4Hz
    IMUData1_LPfilt = IMUData1;   % 4Hz LOWPASS
    IMUData2_LPfilt = IMUData2;   % filtfilt for offline, filter for real-time
    
    % derive knee state (angular velocity)
    for m = 1:ii
    KneeVelocity_(m,1) = IMUData2_LPfilt(m,1) - IMUData1_LPfilt(m,1);
    end
    KneeVelocity = KneeVelocity_ * 500 / 32767 ; % now in dps
    
    % at this poitn should compare this method of int/dif wth diff integral
    integral_KneeVelocity_(1,1) = (KneeVelocity(1,1) * samplePeriod_IMU);
    for n = 2:ii
    integral_KneeVelocity_(n,1) = integral_KneeVelocity_((n-1),1) + (KneeVelocity(n,1) * samplePeriod_IMU);
    end
    integral_KneeVelocity = -integral_KneeVelocity_; % addition for exp1b, probably accounted for in other experiments.
%     figure; plot(1:length(integral_KneeVelocity(:,1)),integral_KneeVelocity(:,1)); title('Integrated (manual) Knee Velocity (Knee Angle) LP:yes HP:no'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si) ]);

%     integral_KneeVelocity_func = integral(KneeVelocity,0,min_str);
    integral_KneeVelocity_func = cumtrapz(-KneeVelocity(:,1));
%     integral_KneeVelocity_func = int(KneeVelocity(:,1));
%     figure; plot(1:length(integral_KneeVelocity_func(:,1)),integral_KneeVelocity_func(:,1)); title('Integrated (function) Knee Velocity (Knee Angle) LP:yes HP:no'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si) ]);

% int16(KneeVelocity);
% max(KneeVelocity(:,1));
% min(KneeVelocity(:,1));

% % %     figure; subplot(2,1,1); plot(1:length(integral_KneeVelocity(:,1)),integral_KneeVelocity(:,1)); title('Integrated (manual) Knee Velocity (Knee Angle) LP:yes HP:no'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si) ]);
% % %             subplot(2,1,2); plot(1:length(integral_KneeVelocity_func(:,1)),integral_KneeVelocity_func(:,1)); title('Integrated (function) Knee Velocity (Knee Angle) LP:yes HP:no'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si) ]);

        
    differential_KneeVelocity(1,1) = KneeVelocity(1,1) *250;
    for p = 2:ii
        differential_KneeVelocity(p,1) = ( KneeVelocity(p,1) - KneeVelocity((p-1),1) ) *freq;
    end                          %      =  ( n - (n-1) ) *250
%     figure; plot(1:length(differential_KneeVelocity(:,1)),differential_KneeVelocity(:,1)); title('Differentiated (manual) Knee Velocity (Knee Acceleration)'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]);
    
    differential_KneeVelocity_func = diff(KneeVelocity(:,1));
%     figure; plot(1:length(differential_KneeVelocity_func(:,1)),differential_KneeVelocity_func(:,1)); title('Differentiated (funcion) Knee Velocity (Knee Acceleration)'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]);

%     figure; subplot(2,1,1); plot(1:length(differential_KneeVelocity(:,1)),differential_KneeVelocity(:,1)); title('Differentiated (manual) Knee Velocity (Knee Acceleration)'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]);
%             subplot(2,1,2); plot(1:length(differential_KneeVelocity_func(:,1)),differential_KneeVelocity_func(:,1)); title('Differentiated (funcion) Knee Velocity (Knee Acceleration)'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]);

            % conclusion: methods complementary but manual methods 1000x
            % function method. explore.
            
    %HIGHPASS HERE :: to remove drift from gyro
    %% NOTE FOR _221 we remove inertial filterng
%     KneeDisplacement_ = filtfilt(d,c,integral_KneeVelocity);
    KneeDisplacement_ = integral_KneeVelocity;
    KneeDisplacement = KneeDisplacement_;
%     KneeDisplacement_func_ = filtfilt(d,c,integral_KneeVelocity_func);
    KneeDisplacement_func_ = integral_KneeVelocity_func;
%     KneeDisplacement_func = KneeDisplacement_func_;
    
    % derive hp freq for thi to be useful
%     figure; subplot(2,1,1); plot(1:length(KneeDisplacement(:,1)),KneeDisplacement(:,1)); title('Knee angle (manual) LP:yes HP:yes'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si) ]);
%             subplot(2,1,2); plot(1:length(KneeDisplacement_func(:,1)),KneeDisplacement_func(:,1)); title('Knee Angle (function) LP:yes HP:yes'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si) ]);


% % % % % % %     ki =( KneeDisplacement_func_(120) - KneeDisplacement_func_(20) ) / 100 ;
% % % % % % % %     20:120
% % % % % % %     
% % % % % % %         for kk = 1:length(KneeDisplacement_func_)
% % % % % % %             KneeDisplacement_func_(kk) = KneeDisplacement_func_(kk) + (ki * (kk-1));
% % % % % % %         end 
            
            
            
% KneeDisplacement_func = integral_KneeVelocity_func;
    KneeDisplacement_func = KneeDisplacement_func_;

    KneeAcceleration = differential_KneeVelocity;
    KneeAcceleration_func = differential_KneeVelocity_func;


    
    %% Quaternion method
    
    nn = exp;
    
    ProcessedtestD0 = QTNData1;
    ProcessedtestD1 = QTNData2; 
    
%     proc_length(nn,1) = length(ProcessedtestD0);
%     proc_length(nn,2) = length(ProcessedtestD1);
%     
%     proc_diff = proc_length(nn,1) - proc_length(nn,2);
%     proc_length(nn,3) = proc_diff;
%     
%     [Y,I] = min(proc_length(nn,1:2));     % THIS MIGHT TAKE A LONG TIME
%     trunc = Y;
%     I;
%     
%     proc_ratio = ( proc_diff / Y ) * 100;
%     proc_length(nn,4) = proc_ratio;
    
    Q1 = ProcessedtestD0(:,1:4);
    Q2 = ProcessedtestD1(:,1:4);
    
    eul1 = quat2eul(Q1);
    eul2 = quat2eul(Q2);
    
    frq1 = fft(eul1);
    frq2 = fft(eul2); 
    
    Q2conj = quatconj(Q2);
    
    Z = quatmultiply(Q1,Q2conj);
    ang = acos(Z(:,1)) * 2 ;
    
    % angle plots with correction for drift and noise (attempted, assess thresholds)
%     ang_cor_for_drift = filtfilt(d,c,ang);   % high pass
%     ang_cor_for_noise = filtfilt(f,e,ang);   % low pass    
    ang_cor_for_drift = ang;   % high pass
    ang_cor_for_noise = ang;   % low pass
%         ang_cor_for_noise_and_drift = filtfilt(h,g,ang);   % band pass

                           %    (not3)  IS THIS STILL CORRECT??
        [m,o] = butter(order,[(2*highpassthresh)/freq_IMU (2*LP_freq)/freq_IMU],'bandpass');
    ang_cor_for_noise_and_drift = filtfilt(m,o,ang);   % band pass %
%     TEMPORARILY REMOVED TO REMOVE FILTER
%     ang_cor_for_noise_and_drift = ang;   % band pass

% % %     figure; plot(ang); title('Knee Angle derived from Quaternions'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']);
%     [PKS_ang,LOCS_ang] = findpeaks(ang); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-ang); scatter(LOCS_ang_neg,-PKS_ang_neg);

%     figure; plot(ang_cor_for_drift); title(['Knee Angle derived from Quaternions with drift removed (' num2str(highpassthresh) 'Hz)']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; HP freq threshold: ' num2str(highpassthresh) ' Hz']);
%     [PKS_angD,LOCS_angD] = findpeaks(ang_cor_for_drift); scatter(LOCS_angD,PKS_angD); [PKS_ang_negD,LOCS_ang_negD] = findpeaks(-ang_cor_for_drift); scatter(LOCS_ang_negD,-PKS_ang_negD);

%     figure; plot(ang_cor_for_noise); title(['Knee Angle derived from Quaternions with noise removed (' num2str(LP_freq) 'Hz)']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']);
%     [PKS_angN,LOCS_angN] = findpeaks(ang_cor_for_noise); scatter(LOCS_angN,PKS_angN); [PKS_ang_negN,LOCS_ang_negN] = findpeaks(-ang_cor_for_noise); scatter(LOCS_ang_negN,-PKS_ang_negN);
    
%     figure; plot(ang_cor_for_noise_and_drift); title(['Knee Angle derived from Quaternions with noise and drift removed (' num2str(highpassthresh) 'Hz and ' num2str(LP_freq) 'Hz)']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; ' num2str(highpassthresh) 'Hz to ' num2str(LP_freq) 'Hz; ' num2str(LP_freq) ' Hz']);
%     [PKS_angDN,LOCS_angDN] = findpeaks(ang_cor_for_noise_and_drift); scatter(LOCS_angDN,PKS_angDN); [PKS_ang_negDN,LOCS_ang_negDN] = findpeaks(-ang_cor_for_noise_and_drift); scatter(LOCS_ang_negDN,-PKS_ang_negDN);
    
    vel = diff(ang);
    acc = diff(vel);

    % if you want to use this plot/data, need to work on it
% figure; subplot(2,1,1); plot(acc); title('Knee Angular Acceleration derived from Quaternions'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); hold on;
%         subplot(2,1,2); plot(1:length(KneeAcceleration(:,1)),KneeAcceleration(:,1),'Color',[0 0 1]); title(['Filtered Knee Acceleration 4Hz lowpass']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']);
  
        
% more filtering

%     figure; plot(1:length(ADCData1),ADCData1); title('ADC pins (IMU 1) filtered'); grid on; grid minor; legend ('show'); % ylim([100 400]);
    
    ADCData1_BPfilt = filtfilt(b,a,ADCData1);
    ADCData2_BPfilt = filtfilt(b,a,ADCData2);
    
%     figure; plot(1:length(ADCData1_BPfilt),ADCData1_BPfilt); title('ADC pins (IMU 1) filtered'); grid on; grid minor; legend ('show'); % ylim([100 400]);

% combined plots for analysis

array = [10,11,12,13];

% % % figure; subplot(3,1,1); plot(integral_KneeVelocity_func);
% % %         subplot(3,1,2); plot(stretched1(:,array,si), 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %         subplot(3,1,3); plot(stretched2(:,array,si), 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

% figure; subplot(4,1,1); plot(integral_KneeVelocity_func, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from gyroscope'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']);
%         subplot(4,1,2); plot(-ang, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from Quaternions'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']);
%         subplot(4,1,3); plot(stretched1(:,array,si), 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
%         subplot(4,1,4); plot(stretched2(:,array,si), 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

% % % figure; subplot(4,1,1); plot(integral_KneeVelocity_func, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from gyroscope'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; %  % ylim manual;
% % %                 subplot(4,1,1); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); ylim(yl); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,1); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); ylim(yl); hold off;% xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % % 
% % %         subplot(4,1,2); plot(-ang, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from Quaternions'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on;
% % %                 subplot(4,1,2); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); ylim(yl);  % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,2); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); ylim(yl); hold off;% xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % % 
% % %         subplot(4,1,3); plot(stretched1(:,array,si), 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); hold on; % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(stretched1(:,17,si), 'LineWidth',1,'Color',[0.2,0.9,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); hold off;% xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % % 
% % %         subplot(4,1,4); plot(stretched2(:,array,si), 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); hold on; % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(stretched2(:,17,si), 'LineWidth',1,'Color',[0.9,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); hold off; % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

                
%                 colour{1} = [0.31 0.46 0.62];
%                 colour{2} = [0.26 0.39 0.52];
%                 colour{3} = [0.27 0.31 0.42];
%                 colour{4} = [0.15 0.23 0.30];

                colour{1} = [0.2 0.3 0.4];
                colour{2} = [0.33 0.44 0.55];
                colour{3} = [0.46 0.57 0.69];
                colour{4} = [0.59 0.71 0.84];
                
%                 colour{4} = [0.2 0.3 0.4];
%                 colour{3} = [0.33 0.44 0.55];
%                 colour{2} = [0.46 0.57 0.69];
%                 colour{1} = [0.59 0.71 0.84];

         si = 1;       

clearvars stretched1 stretched2
% % % % ORIGNAL BYPASSED FILTER FOR MMG
% stretched_raw1(:,10:17) = ADCData1(:,1:8);
% stretched_raw2(:,10:17) = ADCData2(:,1:8); % ,si


%% I HAVE CHOSEN OT REMOVE THE FILTER UNTIL SUCH TIMES AS IT IS NCESSARY FOR CLAIFICATION
% % i HAVE DONE THIS BECUASE I WANT TO SASSESS THE FOOT SWITCH AND BUTTON/SWITCH SSTEM.

% stretched1(:,10:15) = ADCData1_BPfilt(:,1:6); % original
% stretched1(:,16:17) = ADCData1(:,7:8);

stretched1(:,10:15) = ADCData1(:,1:6);
stretched1(:,16:17) = ADCData1(:,7:8);


% stretched2(:,10:15) = ADCData2_BPfilt(:,1:6); % ,si   % original
% stretched2(:,16:17) = ADCData2(:,7:8); % ,si

stretched2(:,10:15) = ADCData2(:,1:6); % ,si
stretched2(:,16:17) = ADCData2(:,7:8); % ,si




% I HAVE REMVED THIS PLOT AS IT SEEMS UNNECSASRY NOW
%{
figure; subplot(2,2,1); plot(ADCData1(:,8)); title(['Unfiltered MMG IMU#1 button channel']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; BP freq: ' num2str(highpassthresh) ' to '  num2str(LP_freq) ' Hz']);  hold on;
        subplot(2,2,2); plot(ADCData1_BPfilt(:,8)); title(['Filtered MMG IMU#1 button channel']); hold on;
        subplot(2,2,3); plot(ADCData2(:,8)); title(['UFiltered MMG IMU#2 button channel']);  hold on;
        subplot(2,2,4); plot(ADCData2_BPfilt(:,8)); title(['Unfiltered MMG IMU#2 button channel']);  hold off;
all_ha = findobj( gcf, 'type', 'axes', 'tag', '' ); %rollover
linkaxes( all_ha, 'x' );
%}



% stretched1(:,17,si) to become ADCData1(:,8)
% stretched2(:,17,si) to become ADCData2(:,8)


% THIS SECTION PLOTS INDIVIDUAL MMG CHANNELS
% %{
figure; grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; BP freq: ' num2str(highpassthresh) ' to '  num2str(LP_freq) ' Hz']); 
for q=2:2:16
subplot(8,2,q-1); plot(stretched1(:,(q/2)+9)); title(['MMG IMU#1 channel ' num2str(q/2)]); hold on; 
end
  
% figure; 
for q=2:2:16
subplot(8,2,q); plot(stretched2(:,(q/2)+9)); title(['MMG IMU#2 channel ' num2str(q/2)]); hold on;
% subplot(9,2,9); plot(IMUData2(:,q));
end
hold off;
all_ha = findobj( gcf, 'type', 'axes', 'tag', '' ); %rollover
linkaxes( all_ha, 'x' );
% %}


% this figure plots angle by gyro, quat, and both sets of IMU ADC MMG Data (unfiltered quat)
% % % figure; subplot(4,1,1); plot(KneeDisplacement_func_, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title(['Knee Angle derived from gyroscope; LP:' num2str(LP_freq) ' Hz, HP:' num2str(highpassthresh) ' Hz']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]);  % ylim manual;
% % %                 [PKS_ang,LOCS_ang] = findpeaks(KneeDisplacement_func_); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-KneeDisplacement_func_); scatter(LOCS_ang_neg,-PKS_ang_neg);
% % % 
% % %         subplot(4,1,1); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl); % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,1); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]);  ylim(yl); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %        %                     -ang
% % %         subplot(4,1,2); plot(+ang, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from Quaternions'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]); 
% % %                 subplot(4,1,2); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl);  % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,2); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl); % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                          [PKS_ang,LOCS_ang] = findpeaks(ang); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-ang); scatter(LOCS_ang_neg,-PKS_ang_neg); hold off;
% % % 
% % %                 
% % %         subplot(4,1,3); plot(stretched1(:,10,si), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU1 MMGs 1:4');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold on; % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(stretched1(:,11,si), 'LineWidth',1,'Color',[colour{3}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(stretched1(:,12,si), 'LineWidth',1,'Color',[colour{2}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(stretched1(:,13,si), 'LineWidth',1,'Color',[colour{1}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                         subplot(4,1,3); plot(stretched1(:,17,si), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % % 
% % %         subplot(4,1,4); plot(stretched2(:,10,si), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU2 MMGs 5:8');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold on; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(stretched2(:,11,si), 'LineWidth',1,'Color',colour{3}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(stretched2(:,12,si), 'LineWidth',1,'Color',colour{2}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(stretched2(:,13,si), 'LineWidth',1,'Color',colour{1}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                         subplot(4,1,4); plot(stretched2(:,17,si), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); hold off; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

%                         savefig([filename '; exp ' num2str(exp) ' segment ' num2str(si) '.fig']);
   


% figure_handle = figure;
% subplot(2,1,1); 
% plot([1:10]);   
% subplot(2,1,2); 
% plot([1:10]+10);

% % find all axes handle of type 'axes' and empty tag
% all_ha = findobj( figure_handle, 'type', 'axes', 'tag', '' );
% linkaxes( all_ha, 'x' );

% %{
figure; subplot(5,1,1); plot(KneeDisplacement_func_, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title(['Knee Angle derived from gyroscope; LP:' num2str(LP_freq) ' Hz, HP:' num2str(highpassthresh) ' Hz']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]);  % ylim manual;  %% , 'tag', 'rollover','color','black'
                [PKS_ang,LOCS_ang] = findpeaks(KneeDisplacement_func_); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-KneeDisplacement_func_); scatter(LOCS_ang_neg,-PKS_ang_neg);

        subplot(5,1,1); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl); % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
%                 subplot(5,1,1); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]);  ylim(yl); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                subplot(5,1,1); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]);  ylim(yl); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
       %                     -ang
        subplot(5,1,2); plot(+ang_cor_for_noise, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from Quaternions [corrected for noise]'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]); 
                subplot(5,1,2); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl); hold on; % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
%                 subplot(5,1,2); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl); % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                         [PKS_ang,LOCS_ang] = findpeaks(ang_cor_for_noise); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-ang_cor_for_noise); scatter(LOCS_ang_neg,-PKS_ang_neg); hold off;

                 % note:      IMUData1 !!!
        subplot(5,1,3); plot(IMUData2(:,7:9));  yl = ylim;   grid on; grid minor; hold on;                 
%                 subplot(5,1,3); plot((stretched1(:,10:17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl);  % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
%                 subplot(5,1,3); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl); hold off; %   % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                subplot(5,1,3); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl); hold off; %   % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

                         
                         
        subplot(5,1,4); plot(stretched1(:,10:11,si), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU1 MMGs 1:4');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold on; % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                subplot(5,1,4); plot(stretched1(:,12:13,si), 'LineWidth',1,'Color',[colour{3}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                subplot(5,1,4); plot(stretched1(:,14:15,si), 'LineWidth',1,'Color',[colour{2}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                subplot(5,1,4); plot(stretched1(:,16:17,si), 'LineWidth',1,'Color',[colour{1}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                        subplot(5,1,4); plot(stretched1(:,17,si), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

        subplot(5,1,5); plot(stretched2(:,10:11,si), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU2 MMGs 5:8');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold on; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                subplot(5,1,5); plot(stretched2(:,12:13,si), 'LineWidth',1,'Color',colour{3}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                subplot(5,1,5); plot(stretched2(:,14:15,si), 'LineWidth',1,'Color',colour{2}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                subplot(5,1,5); plot(stretched2(:,16:17,si), 'LineWidth',1,'Color',colour{1}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
%                         subplot(5,1,5); plot(stretched2(:,17,si), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); hold off; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
                        subplot(5,1,5); plot(stretched1(:,17,si), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); hold off; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

all_ha = findobj( gcf, 'type', 'axes', 'tag', '' ); %rollover
linkaxes( all_ha, 'x' );
%}

% pointerBehavior.enterFcn =@(hfig, cpp)set(findobj(hfig, 'tag', 'rollover'), 'color', 'red');
% pointerBehavior.traverseFcn = [];
% pointerBehavior.exitFcn = @(hfig, cpp)set(findobj(hfig, 'tag', 'rollover'), 'color', 'black');
% iptSetPointerBehavior(hp, pointerBehavior);
% iptPointerManager(hf, 'enable');


% % fro exp 97 quat plot error
%         figure; plot(+ang_cor_for_noise, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from Quaternions [corrected for noise]'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; % hold on; % xlim([0 i]); 

% % for 97
% figure; plot(KneeDisplacement_func_, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title(['Knee Angle derived from gyroscope; LP:' num2str(LP_freq) ' Hz, HP:' num2str(highpassthresh) ' Hz']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]);  % ylim manual;
%                 [PKS_ang,LOCS_ang] = findpeaks(KneeDisplacement_func_); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-KneeDisplacement_func_); scatter(LOCS_ang_neg,-PKS_ang_neg);
%         plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl); % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
%         plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]);  ylim(yl); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
  

      ang_cor_for_drift ;
    ang_cor_for_noise ;
    
    
                            
% this figure plots angle by gyro, quat, and both sets of IMU ADC MMG Data (filtered quat)                        
% % %         figure; subplot(4,1,1); plot(KneeDisplacement_func_, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title(['Knee Angle derived from gyroscope; LP:' num2str(LP_freq) ' Hz, HP:' num2str(highpassthresh) ' Hz']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]);  % ylim manual;
% % %                 [PKS_ang,LOCS_ang] = findpeaks(KneeDisplacement_func_); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-KneeDisplacement_func_); scatter(LOCS_ang_neg,-PKS_ang_neg);
% % % 
% % %         subplot(4,1,1); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl); % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,1); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]);  ylim(yl); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %        %                     -ang
% % %         subplot(4,1,2); plot(+ang_cor_for_noise, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from Quaternions [angle corrected for noise]'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]); 
% % %                 subplot(4,1,2); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl);  % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,2); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); ylim(yl);% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                                 [PKS_ang,LOCS_ang] = findpeaks(ang_cor_for_noise); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-ang_cor_for_noise); scatter(LOCS_ang_neg,-PKS_ang_neg); hold off;
% % %                 
% % %         subplot(4,1,3); plot(stretched1(:,10,si), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU1 MMGs 1:4');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold on; % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(stretched1(:,11,si), 'LineWidth',1,'Color',[colour{3}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(stretched1(:,12,si), 'LineWidth',1,'Color',[colour{2}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(stretched1(:,13,si), 'LineWidth',1,'Color',[colour{1}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                         subplot(4,1,3); plot(stretched1(:,17,si), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % % 
% % %         subplot(4,1,4); plot(stretched2(:,10,si), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU2 MMGs 5:8');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold on; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(stretched2(:,11,si), 'LineWidth',1,'Color',colour{3}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(stretched2(:,12,si), 'LineWidth',1,'Color',colour{2}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(stretched2(:,13,si), 'LineWidth',1,'Color',colour{1}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                         subplot(4,1,4); plot(stretched2(:,17,si), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); hold off; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

                        
                     
                        
                   % correct high pass threshold before using this   [m,o] above   
% %                             figure; subplot(4,1,1); plot(KneeDisplacement_func_, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title(['Knee Angle derived from gyroscope; LP:' num2str(LP_freq) ' Hz, HP:' num2str(highpassthresh) ' Hz']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]);  % ylim manual;
% %                 [PKS_ang,LOCS_ang] = findpeaks(KneeDisplacement_func_); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-KneeDisplacement_func_); scatter(LOCS_ang_neg,-PKS_ang_neg);
% % 
% %         subplot(4,1,1); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ]); ylim(yl); % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                 subplot(4,1,1); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ]);  ylim(yl); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %        %                     -ang
% %         subplot(4,1,2); plot(+ang_cor_for_noise_and_drift, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from Quaternions [angle corrected for noise and drift]['); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]); 
% %                 subplot(4,1,2); plot((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ]); ylim(yl);  % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                 subplot(4,1,2); plot((stretched2(:,17,si)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ]); ylim(yl);% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                               [PKS_ang,LOCS_ang] = findpeaks(ang_cor_for_noise_and_drift); scatter(LOCS_ang,PKS_ang); [PKS_ang_neg,LOCS_ang_neg] = findpeaks(-ang_cor_for_noise_and_drift); scatter(LOCS_ang_neg,-PKS_ang_neg); hold off;
% % 
% %         subplot(4,1,3); plot(stretched1(:,10,si), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU1 MMGs 1:4');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp)]); hold on; % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                 subplot(4,1,3); plot(stretched1(:,11,si), 'LineWidth',1,'Color',[colour{3}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                 subplot(4,1,3); plot(stretched1(:,12,si), 'LineWidth',1,'Color',[colour{2}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                 subplot(4,1,3); plot(stretched1(:,13,si), 'LineWidth',1,'Color',[colour{1}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                         subplot(4,1,3); plot(stretched1(:,17,si), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ]); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % 
% %         subplot(4,1,4); plot(stretched2(:,10,si), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU2 MMGs 5:8');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ]); hold on; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                 subplot(4,1,4); plot(stretched2(:,11,si), 'LineWidth',1,'Color',colour{3}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                 subplot(4,1,4); plot(stretched2(:,12,si), 'LineWidth',1,'Color',colour{2}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                 subplot(4,1,4); plot(stretched2(:,13,si), 'LineWidth',1,'Color',colour{1}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% %                         subplot(4,1,4); plot(stretched2(:,17,si), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); hold off; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

                        
                
% % % figure; subplot(4,1,1); plot(KneeDisplacement_func_, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title(['Knee Angle derived from gyroscope; LP:' num2str(LP_freq) ' Hz, HP:' num2str(highpassthresh) ' Hz']); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]);  % ylim manual;
% % %                 subplot(4,1,1); plot((ADCData1(:,8)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); ylim(yl); % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,1); plot((ADCData2(:,8)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]);  ylim(yl); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %        %                     -ang
% % %         subplot(4,1,2); plot(+ang, 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Knee Angle derived from Quaternions'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']); yl = ylim; hold on; % xlim([0 i]); 
% % %                 subplot(4,1,2); plot((ADCData1(:,8)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); ylim(yl);  % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,2); plot((ADCData2(:,8)*(yl(2)-yl(1))/1000)+yl(1), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); ylim(yl); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 
% % %         subplot(4,1,3); plot(ADCData1(:,1), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU1 MMGs 1:4');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); hold on; % xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(ADCData1(:,2), 'LineWidth',1,'Color',[colour{3}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(ADCData1(:,3), 'LineWidth',1,'Color',[colour{2}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,3); plot(ADCData1(:,4), 'LineWidth',1,'Color',[colour{1}]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                         subplot(4,1,3); plot(ADCData1(:,8), 'LineWidth',1,'Color',[0.2,0.9,0.4]); grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); hold off;% xlim([0 i]); xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % % 
% % %         subplot(4,1,4); plot(ADCData2(:,1), 'LineWidth',1,'Color',colour{4}); title('Stretched and Normalised data segment, IMU2 MMGs 5:8');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); hold on; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(ADCData2(:,2), 'LineWidth',1,'Color',colour{3}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(ADCData2(:,3), 'LineWidth',1,'Color',colour{2}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                 subplot(4,1,4); plot(ADCData2(:,4), 'LineWidth',1,'Color',colour{1}); grid on; grid minor; ylim([100 400]); % xlim([0 i]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% % %                         subplot(4,1,4); plot(ADCData2(:,8), 'LineWidth',1,'Color',[0.9,0.3,0.4]); grid on; grid minor; ylim([100 400]); hold off; % xlim([0 i]);  xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

%                         savefig([filename '; exp ' num2str(exp) ' segment ' num2str(si) '.fig']);
       
        
%  % colours       
% figure; subplot(4,1,1); plot(integral_KneeVelocity_func, 'LineWidth',1,'Color',[0.31 0.46 0.62]); title('Knee Angle derived from gyroscope'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']);
%         subplot(4,1,2); plot(-ang, 'LineWidth',1,'Color',[0.26 0.39 0.52]); title('Knee Angle derived from Quaternions'); grid on; grid minor; set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) '; LP freq threshold: ' num2str(LP_freq) ' Hz']);
%         subplot(4,1,3); plot(stretched1(:,array,si), 'LineWidth',1,'Color',[0.27 0.31 0.42]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
%         subplot(4,1,4); plot(stretched2(:,array,si), 'LineWidth',1,'Color',[0.15 0.23 0.30]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 
% 
%         lineStyles = linspecer(4,'sequential');
        
%         ((stretched1(:,17,si)*(yl(2)-yl(1))/1000)+yl(1))
%         yl(1) yl(2)
%         
%         yl(2) - yl(1)
%         *yl(2)/1000       % original for zero yl(1)
        
        
        
        
        
%     figure; plot(stretched1(:,17,si), 'LineWidth',1,'Color',[0.2,0.3,0.4]); title('Stretched and Normalised data segment');  grid on; grid minor; ylim([100 400]); set(gcf,'numbertitle','on','name',[filename '; exp ' num2str(exp) ' segment ' num2str(si)]); ylim([-10 1234]); %  xlim([10 100]); ylim(yl); % xlabel(['Stride time, seconds']); ylabel('Knee Angle, degrees'); 

toc

end

toc